<!DOCTYPE html>
<html>

<head>
  <link href="vue/materialdesignicons.min.css" rel="stylesheet">
  <link href="fonts/roboto/roboto.css" rel="stylesheet">
  <link href="vue/vuetify.min.css" rel="stylesheet">
  <!-- <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet"> -->
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, minimal-ui">
  <script src="vue/vue.min.js"></script>
  <script src="vue/vuetify.min.js"></script>
  <!-- <script type="module" src="app.js"></script> -->
  <style>
    .md3-dialog {
      border-radius: 32px !important;
    }
  </style>
</head>

<body>
  <div id="app">
    <v-app>

      <v-dialog persistent v-model="openConfig" max-width="600px">

        <v-card class="md3-dialog" elevation="12">

          <v-card-title>
            <v-btn :disabled="!hasClientName" icon @click="openConfig = false">
              <v-icon>mdi-close</v-icon>
            </v-btn>

            <h3 class="col-6">Tracking numbers</h3>

            <v-spacer></v-spacer>

            <v-text-field class="align-start col-3" v-model="intervalTime"
                          :rules="[computedInternvalTimeout >= minimummTimeout || 'Timeout should upper 30s']"
                          v-show="hasClientName" rounded hide-details="auto" label="Timeout" type="number" :min="minimummTimeout"
                          dense class="mt-3" width="100px" outlined>

              <template v-slot:append>
                <v-menu offset-y>
                  <template v-slot:activator="{ on, attrs }">
                    <v-btn x-small text rounded v-bind="attrs" v-on="on">
                      {{ timeParts[intervalTimePart][0] }}
                    </v-btn>
                  </template>
                  <v-list dense>
                    <v-list-item v-for="(part, index) in timeParts" :key="index" @click="intervalTimePart = index">
                      <v-list-item-title>{{ part }}</v-list-item-title>
                    </v-list-item>
                  </v-list>
                </v-menu>
              </template>

            </v-text-field>

          </v-card-title>

          <v-divider></v-divider>

          <v-card-text>
            <v-text-field min="4" rounded v-show="!hasClientName" v-model="editClientName" hide-details="auto"
                          label="Client name" outlined :rules="nameRules" class="mt-6"
                          @keypress.enter="!cantSaveName && saveName()">
              <v-icon :disabled="cantSaveName" class="mx-2" slot="append-outer" @click="saveName">
                mdi-content-save-check-outline
              </v-icon>
            </v-text-field>

            <v-row class="my-5 ml-0" v-show="hasClientName">
              <v-text-field class="align-start col-6" v-model="trackingNumberEdit" :rules="trackingNumberRules"
                            v-show="hasClientName" rounded hide-details="auto" label="Tracking number" dense outlined
                            @keypress.enter="!cantAddTrackingNumber && addTrackingNumber(trackingNumberEdit)">
                <v-icon :disabled="cantAddTrackingNumber" class="mr-3" slot="append-outer"
                  @click="addTrackingNumber(trackingNumberEdit)">
                  mdi-plus
                </v-icon>
              </v-text-field>
            </v-row>

            <v-list v-show="hasClientName">
              <v-list-item v-for="key in Object.keys(logs)" :key="key">
                <v-list-item-content>
                  <v-list-item-title>#{{ key }}</v-list-item-title>
                </v-list-item-content>
                <v-list-item-action>
                  <v-btn icon small @click="removeTrackingNumber(key)">
                    <v-icon>mdi-close</v-icon>
                  </v-btn>
                </v-list-item-action>
              </v-list-item>
              <v-list-item v-if="Object.keys(logs).length === 0">
                <v-list-item-content>
                  <v-list-item-subtitle class="text-center">No tracking numbers added yet</v-list-item-subtitle>
                </v-list-item-content>
              </v-list-item>
            </v-list>
          </v-card-text>

          <v-divider v-if="hasClientName"></v-divider>

          <v-card-actions v-if="hasClientName">
            <v-spacer></v-spacer>
            <v-btn :disabled="!nonTrackedNumbers.length" @click="openConfig = false; watchForNumbers()" outlined rounded
              class="mr-3 pr-4 my-4" color="primary">
              <v-icon left>mdi-eye-arrow-right</v-icon>
              Track
            </v-btn>
          </v-card-actions>

        </v-card>

      </v-dialog>

      <v-main>
        <v-container>
          <v-row class="my-4 mx-4">
            <v-spacer></v-spacer>
            <div>
              <v-list-item>
                <v-list-item-content>
                  <v-list-item-title class="text-right">{{currentClient || 'Guess'}}</v-list-item-title>
                  <!-- <v-list-item-subtitle class="text-right">refresh {{computedInternvalTimeout}}</v-list-item-subtitle> -->
                </v-list-item-content>
                <v-list-item-action>
                  <v-badge overlap>
                    <v-icon v-if="currentClient" slot="badge" @click="clearSession">mdi-close</v-icon>
                    <v-avatar size="64">
                      <v-icon size="60">mdi-account-circle</v-icon>
                    </v-avatar>
                  </v-badge>
                </v-list-item-action>
              </v-list-item>
            </div>
          </v-row>
          <v-row class="my-4 mx-4" v-show="!hasntLogs">
            <v-spacer></v-spacer>
            <v-btn outlined rounded color="primary" right @click="openConfig = true">
              <v-icon left>mdi-plus</v-icon>
              Add tracking numbers
            </v-btn>
          </v-row>
          <v-row v-if="hasntLogs" class="my-8">
            <v-col class="text-center">
              <v-icon size="84" color="grey lighten-1" class="mb-4">mdi-package-variant-closed</v-icon>
              <h2 class="grey--text text--darken-1">No tracking numbers yet</h2>
              <p class="grey--text text-caption">Add tracking numbers to start monitoring your shipments</p>
              <v-btn color="primary" class="mt-3" rounded outlined @click="openConfig = true">
                <v-icon left>mdi-plus</v-icon>
                Add your first tracking numbers
              </v-btn>
            </v-col>
          </v-row>
          <v-expansion-panels multiple class="md3-dialog" popout>
            <v-expansion-panel :disabled="!!logs.error" v-for="[num, logs] in Object.entries(logs)">
              <v-expansion-panel-header ripple>
                <v-row justify="space-between" align="center">
                  <v-col cols="auto">
                    <v-avatar>
                      <v-icon>mdi-truck-delivery</v-icon>
                      <v-progress-circular v-show="isLoading(num)" style="position: absolute;" indeterminate
                        size="44" />
                    </v-avatar>
                  </v-col>
                  <v-col>
                    <h3 class="mb-2">#{{num}}</h3>
                    <v-chip x-small v-if="logs.error" color="red">{{logs.error}}</v-chip>
                    <span v-else-if="logs.lastUpdated" class="text--secondary">{{logs.lastUpdated | toRelative}}</span>
                    <span v-else class="text--secondary">(Not updated)</span>
                  </v-col>
                </v-row>
              </v-expansion-panel-header>
              <v-expansion-panel-content>
                <v-list-item v-for="log in logs.history" :key="log.timestamp">
                  <v-list-item-content>
                    <v-list-item-title>{{ log.company || 'Unknown location' }}</v-list-item-title>
                    <v-list-item-subtitle>{{ log.location || 'Unknown company ' }}</v-list-item-subtitle>
                  </v-list-item-content>
                  <v-list-item-action>
                    <v-chip color="success">{{log.status}}</v-chip>
                    <span class="pt-2 v-list-item__subtitle">{{log.timestamp | toRelative}}</span>
                  </v-list-item-action>
                </v-list-item>
              </v-expansion-panel-content>
            </v-expansion-panel>
          </v-expansion-panels>
        </v-container>
      </v-main>
    </v-app>
  </div>

  <style>
    @keyframes dialog-enter {
      0% {
        transform: translate(0, -100px) scale(0.7);
        opacity: 0;
      }

      100% {
        transform: translate(0, 0) scale(1);
        opacity: 1;
      }
    }

    .md3-dialog {
      animation: dialog-enter 0.3s ease-out forwards;
      /* transform-origin: center; */
    }
  </style>

  <script type="module">
    import { HubConnectionBuilder } from "./signalr.min.js"
    import { read, write } from './localstore.js'

    let clientName = read('currentClient') || '';

    const TIMEOUT = 3 * 60 * 1000,
      parts = {
        s: 1000,
        m: 60 * 1000,
        h: 60 * 60 * 1000
      },
      [intervalTime, intervalTimePart] = (read(`${clientNameAsId(clientName)}_interval`) ?? [TIMEOUT, 0]),
      rtf = new Intl.RelativeTimeFormat('en', { numeric: 'auto' });

    new Vue({
      el: '#app',
      vuetify: new Vuetify({
        theme: {
          dark: window.matchMedia?.('(prefers-color-scheme: dark)')?.matches ?? true,
          options: {
            themeCache: {
              get: key => localStorage.getItem(key),
              set: (key, value) => (console.log(key), localStorage.setItem(key, value)),
            },
          }
        }
      }),
      filters: {
        toRelative(v) {
          const now = Date.now(),
            diffMs = new Date(v) - now,
            diffSeconds = Math.round(diffMs / 1000),
            diffMinutes = Math.round(diffSeconds / 60),
            diffHours = Math.round(diffMinutes / 60),
            diffDays = Math.round(diffHours / 24),
            diffWeeks = Math.round(diffDays / 7),
            diffMonths = Math.round(diffDays / 30.42), // Average days per month
            diffYears = Math.round(diffDays / 365.25); // Average days per year (accounting for leap years)

          if (Math.abs(diffYears) >= 1) return rtf.format(diffYears, 'year');
          if (Math.abs(diffMonths) >= 1) return rtf.format(diffMonths, 'month');
          if (Math.abs(diffWeeks) >= 1) return rtf.format(diffWeeks, 'week');
          if (Math.abs(diffDays) >= 1) return rtf.format(diffDays, 'day');
          if (Math.abs(diffHours) >= 1) return rtf.format(diffHours, 'hour');
          if (Math.abs(diffMinutes) >= 1) return rtf.format(diffMinutes, 'minute');
          if (Math.abs(diffSeconds) >= 1) return rtf.format(diffSeconds, 'second');
          return rtf.format(0, 'second'); // Fallback for no difference
        }
      },
      computed: {
        computedInternvalTimeout() {
          return this.intervalTime * parts[this.timeParts[this.intervalTimePart][0]] || TIMEOUT;
        },
        nonTrackedNumbers() {
          return Object.keys(this.logs).filter(tn => !this.isLoading(tn));
        },
        hasntLogs() {
          return Object.keys(this.logs).length === 0
        },
        hasClientName() {
          return !!this.currentClient?.trim()
        },
        cantSaveName() {
          return this.nameRules.some(r => typeof r === "string");
        },
        nameRules() {
          return this.rules.map(r => r(this.editClientName.trim()));
        },
        cantAddTrackingNumber() {
          return this.trackingNumberRules.some(r => typeof r === "string");
        },
        trackingNumberRules() {
          return this.rules
            .concat(v => !(v?.trim() in this.logs) || "Number already exists")
            .map(r => r(this.trackingNumberEdit.trim()));
        }
      },
      data: {
        trackingNumberEdit: '',
        minimummTimeout: TIMEOUT,
        editClientName: '',
        loadingItems: [],
        intervalRef: null,
        intervalTime,
        intervalTimePart,
        timeParts: ['second(s)', 'minute(s)', 'hour(s)'],
        currentClient: clientName,
        openConfig: false,
        rules: [
          v => !!v || 'Value is required',
          v => (v.length > 4) || 'Value must be less than 4 characters',
        ],
        logs: read(clientNameAsId(clientName)) ?? {},
        signalRConnection: new HubConnectionBuilder().withUrl("/ordertracker").build()
      },
      watch: {
        computedInternvalTimeout(v) {
          if (v > TIMEOUT) {
            write(`${clientNameAsId(clientName)}_interval`, [this.intervalTime, this.intervalTimePart]);
          }
        }
      },
      created() {
        this.connect().then();
      },
      methods: {
        clearSession(){
          Object.keys(localStorage).forEach(key => {
            localStorage.removeItem(key);
          });
          this.currentClient = this.editClientName = this.trackingNumberEdit = '';
          this.logs = {};
          this.loadingItems = [];
          this.openConfig = true;
          // this.signalRConnection.stop().then(() => {
          //   console.log("SignalR disconnected");
          //   clearInterval(this.intervalRef);
          // });
        },
        saveName() {
          // const shouldPreserveLogs = this.currentClient !== this.$refs.clientNameInput.internalValue;
          write('currentClient', this.currentClient = this.editClientName);
          write(clientNameAsId(this.currentClient), this.logs = {});
        },
        addTrackingNumber(trackingNumber) {
          this.$set(this.logs, trackingNumber, { lastUpdated: null, error: null, history: [] });
          write(clientNameAsId(this.currentClient), this.logs);
          this.trackingNumberEdit = '';
        },
        removeTrackingNumber(key) {
          this.removeLoadingItem(key);
          this.$delete(this.logs, key);
          this.$nextTick(() => write(clientNameAsId(this.currentClient), this.logs));
        },
        isLoading(key) {
          return this.loadingItems.includes(key);
        },
        addLoadingItems(...tracingNumbers) {
          this.loadingItems.push(...tracingNumbers);
        },
        removeLoadingItem(...tracingNumbers) {
          this.loadingItems = this.loadingItems.filter(tn => !tracingNumbers.includes(tn));
        },
        async connect() {
          try {
            await this.signalRConnection.start();
            console.log("SignalR connected");
            this.watchForNumbers();
          } catch (err) {
            console.error("Error connecting to SignalR:", err);
          }
        },
        watchForNumbers() {
          // Exit if SignalR is not connected
          if (this.signalRConnection.state !== "Connected") {
            console.log("SignalR not connected, attempting to connect...");
            return; // Don't proceed if not connected
          }
          if (this.intervalRef !== null) {
            clearInterval(this.interval);
          }

          const numbersToTrack = this.nonTrackedNumbers;

          if (!numbersToTrack.length) {
            return;
          }

          this.addLoadingItems(...numbersToTrack);

          this.signalRConnection.off("Update", this.receiveUpdates);
          this.signalRConnection.on("Update", this.receiveUpdates);
          this.signalRConnection.invoke('UpdateConnectionIdAsync', this.currentClient, numbersToTrack).then();

          this.intervalRef = setInterval(this.watchForNumbers, this.computedInternvalTimeout);
        },
        receiveUpdates({ trackingNumber, history, error }) {
          this.removeLoadingItem(trackingNumber);
          if (error) {
            const { status, lastUpdated = new Date().toJSON(), history } = this.logs;
            console.error("Error receiving updates:", error);
            this.$set(this.logs, trackingNumber, { status, lastUpdated, error, history });
          }
          else{
            this.$set(this.logs, trackingNumber, { status: history[0]?.status, lastUpdated: history[0]?.timestamp, error, history });
          }
          write(clientNameAsId(this.currentClient), this.logs);
        }
      }
    });



    function clientNameAsId(client) {
      return client.replaceAll(/[^\w]+/g, '_') + "_logs";
    }


  </script>
</body>

</html>